<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator - Restaurant System</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📱</text></svg>">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-title">
                    <h1>📱 QR Code Generator</h1>
                    <p class="subtitle">Generate QR codes for restaurant tables</p>
                </div>
                <div class="header-actions">
                    <a href="/dashboard" class="btn btn-outline">
                        <span>📊</span>
                        Dashboard
                    </a>
                    <a href="/" class="btn btn-outline">
                        <span>🏠</span>
                        Home
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="qr-generator-section">
            <div class="generator-controls card">
                <div class="card-header">
                    <h2>Generate QR Codes</h2>
                    <p>Create QR codes that customers can scan to access the menu for their table.</p>
                </div>
                
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="server-ip">Server IP Address</label>
                            <input 
                                type="text" 
                                id="server-ip" 
                                class="form-input"
                                placeholder="192.168.1.10" 
                                value="192.168.1.10"
                            >
                            <small class="form-help">Enter the local IP address where the restaurant system is hosted</small>
                        </div>

                        <div class="form-group">
                            <label for="port-number">Port Number</label>
                            <input 
                                type="number" 
                                id="port-number" 
                                class="form-input"
                                placeholder="3000" 
                                value="3000"
                            >
                            <small class="form-help">Server port number (default: 3000)</small>
                        </div>
                    </div>

                    <div class="generation-options">
                        <div class="option-group card">
                            <div class="card-header">
                                <h3>Single Table</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="single-table">Table Number</label>
                                        <input 
                                            type="number" 
                                            id="single-table" 
                                            class="form-input"
                                            min="1" 
                                            placeholder="1"
                                        >
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-primary" onclick="generateSingleQR()">
                                            <span>🎯</span>
                                            Generate QR Code
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="option-group card">
                            <div class="card-header">
                                <h3>Multiple Tables</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="start-table">Start Table</label>
                                        <input 
                                            type="number" 
                                            id="start-table" 
                                            class="form-input"
                                            min="1" 
                                            placeholder="1"
                                            value="1"
                                        >
                                    </div>
                                    <div class="form-group">
                                        <label for="end-table">End Table</label>
                                        <input 
                                            type="number" 
                                            id="end-table" 
                                            class="form-input"
                                            min="1" 
                                            placeholder="10"
                                            value="10"
                                        >
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-primary" onclick="generateMultipleQR()">
                                            <span>📋</span>
                                            Generate All QR Codes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QR Code Display Area -->
            <div class="qr-display-area card" id="qr-display-area">
                <div class="welcome-message">
                    <div class="welcome-header">
                        <h3>Welcome to QR Code Generator</h3>
                        <p>Generate QR codes for your restaurant tables. Customers can scan these codes to access the menu directly from their phones.</p>
                    </div>
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">📱</div>
                            <h4>Easy Scanning</h4>
                            <p>Customers scan with any QR code reader</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🍽️</div>
                            <h4>Table-Specific</h4>
                            <p>Each QR code links to the correct table</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">💾</div>
                            <h4>Download & Print</h4>
                            <p>Save QR codes as images for printing</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions-section card">
            <div class="card-header">
                <h2>How to Use</h2>
            </div>
            <div class="card-body">
                <div class="instruction-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Set Server Details</h3>
                            <p>Enter your local server IP address and port number. This is usually the IP of the computer running the restaurant system.</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>Generate QR Codes</h3>
                            <p>Choose to generate a single QR code for one table, or generate multiple QR codes for a range of tables.</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Download & Print</h3>
                            <p>Right-click on any QR code to save it as an image. Print and place them on the corresponding tables.</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h3>Test Scanning</h3>
                            <p>Test each QR code with a phone to ensure it opens the correct table menu page.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <h3>Generating QR Codes...</h3>
            <p id="loading-message">Please wait while we generate your QR codes.</p>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="alert">
        <span id="notification-message"></span>
    </div>

    <script>
        // Generate single QR code
        async function generateSingleQR() {
            const tableNumber = document.getElementById('single-table').value;
            const serverIP = document.getElementById('server-ip').value;
            const port = document.getElementById('port-number').value;

            if (!tableNumber) {
                showNotification('Please enter a table number', 'error');
                return;
            }

            if (!serverIP) {
                showNotification('Please enter server IP address', 'error');
                return;
            }

            showLoading('Generating QR code for table ' + tableNumber + '...');

            try {
                const response = await fetch('/api/qr/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tableNumber: parseInt(tableNumber),
                        serverIP: serverIP,
                        port: port
                    })
                });

                if (!response.ok) throw new Error('Failed to generate QR code');

                const result = await response.json();
                displaySingleQR(tableNumber, result.qrCodeDataURL, `http://${serverIP}:${port}/table/${tableNumber}`);
                showNotification('QR code generated successfully!', 'success');

            } catch (error) {
                console.error('Error generating QR code:', error);
                showNotification('Failed to generate QR code', 'error');
            } finally {
                hideLoading();
            }
        }

        // Generate multiple QR codes
        async function generateMultipleQR() {
            const startTable = parseInt(document.getElementById('start-table').value);
            const endTable = parseInt(document.getElementById('end-table').value);
            const serverIP = document.getElementById('server-ip').value;
            const port = document.getElementById('port-number').value;

            if (!startTable || !endTable) {
                showNotification('Please enter start and end table numbers', 'error');
                return;
            }

            if (startTable > endTable) {
                showNotification('Start table must be less than or equal to end table', 'error');
                return;
            }

            if (!serverIP) {
                showNotification('Please enter server IP address', 'error');
                return;
            }

            const totalTables = endTable - startTable + 1;
            showLoading(`Generating QR codes for ${totalTables} tables...`);

            try {
                const response = await fetch('/api/qr/generate-multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        startTable: startTable,
                        endTable: endTable,
                        serverIP: serverIP,
                        port: port
                    })
                });

                if (!response.ok) throw new Error('Failed to generate QR codes');

                const result = await response.json();
                displayMultipleQR(result.qrCodes, serverIP, port);
                showNotification(`Generated ${result.qrCodes.length} QR codes successfully!`, 'success');

            } catch (error) {
                console.error('Error generating QR codes:', error);
                showNotification('Failed to generate QR codes', 'error');
            } finally {
                hideLoading();
            }
        }

        // Display single QR code
        function displaySingleQR(tableNumber, qrDataURL, url) {
            const displayArea = document.getElementById('qr-display-area');
            displayArea.innerHTML = `
                <div class="qr-results">
                    <div class="results-header">
                        <h3>Generated QR Code - Table ${tableNumber}</h3>
                        <div class="header-actions">
                            <button class="btn btn-outline" onclick="downloadQR('${qrDataURL}', 'table-${tableNumber}-qr.png')">
                                <span>📥</span>
                                Download
                            </button>
                            <button class="btn btn-outline" onclick="printQR('${qrDataURL}', '${tableNumber}')">
                                <span>🖨️</span>
                                Print
                            </button>
                        </div>
                    </div>
                    <div class="qr-single-display">
                        <div class="qr-card large">
                            <div class="qr-card-header">
                                <h4>Table ${tableNumber}</h4>
                                <p class="qr-url">${url}</p>
                            </div>
                            <div class="qr-code-container">
                                <img src="${qrDataURL}" alt="QR Code for Table ${tableNumber}" class="qr-code-large">
                            </div>
                            <div class="qr-card-actions">
                                <button class="btn btn-primary" onclick="downloadQR('${qrDataURL}', 'table-${tableNumber}-qr.png')">
                                    <span>📥</span>
                                    Download PNG
                                </button>
                                <button class="btn btn-outline" onclick="printQR('${qrDataURL}', '${tableNumber}')">
                                    <span>🖨️</span>
                                    Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Display multiple QR codes
        function displayMultipleQR(qrCodes, serverIP, port) {
            const displayArea = document.getElementById('qr-display-area');
            
            const qrGrid = qrCodes.map(qr => `
                <div class="qr-card">
                    <div class="qr-card-header">
                        <h4>Table ${qr.tableNumber}</h4>
                    </div>
                    <div class="qr-code-container">
                        <img src="${qr.qrCodeDataURL}" alt="QR Code for Table ${qr.tableNumber}" class="qr-code-small">
                    </div>
                    <p class="qr-url">http://${serverIP}:${port}/table/${qr.tableNumber}</p>
                    <div class="qr-card-actions">
                        <button class="btn btn-small btn-primary" onclick="downloadQR('${qr.qrCodeDataURL}', 'table-${qr.tableNumber}-qr.png')">
                            <span>📥</span>
                            Download
                        </button>
                    </div>
                </div>
            `).join('');

            displayArea.innerHTML = `
                <div class="qr-results">
                    <div class="results-header">
                        <h3>Generated QR Codes (${qrCodes.length} tables)</h3>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="downloadAllQR()">
                                <span>📥</span>
                                Download All
                            </button>
                        </div>
                    </div>
                    <div class="qr-grid">
                        ${qrGrid}
                    </div>
                </div>
            `;
        }

        // Download QR code
        function downloadQR(dataURL, filename) {
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('QR code downloaded!', 'success');
        }

        // Print QR code
        function printQR(dataURL, tableNumber) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Table ${tableNumber} QR Code</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                text-align: center; 
                                padding: 20px; 
                            }
                            .qr-print { 
                                max-width: 300px; 
                                margin: 20px auto; 
                            }
                            h1 { 
                                font-size: 24px; 
                                margin-bottom: 10px; 
                            }
                            p { 
                                font-size: 16px; 
                                margin: 10px 0; 
                            }
                        </style>
                    </head>
                    <body>
                        <h1>Table ${tableNumber}</h1>
                        <div class="qr-print">
                            <img src="${dataURL}" style="width: 100%; height: auto;">
                        </div>
                        <p>Scan to view menu and place order</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Show loading modal
        function showLoading(message = 'Loading...') {
            const modal = document.getElementById('loading-modal');
            const messageEl = document.getElementById('loading-message');
            messageEl.textContent = message;
            modal.style.display = 'flex';
        }

        // Hide loading modal
        function hideLoading() {
            const modal = document.getElementById('loading-modal');
            modal.style.display = 'none';
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notification-message');
            
            messageEl.textContent = message;
            notification.className = `alert alert-${type}`;
            notification.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
            }, 4000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Try to detect local IP
            detectLocalIP();
        });

        // Try to detect local IP address
        function detectLocalIP() {
            // This is a simple attempt - in a real scenario, the server IP should be configured
            const hostname = window.location.hostname;
            if (hostname && hostname !== 'localhost' && hostname !== '127.0.0.1') {
                document.getElementById('server-ip').value = hostname;
            }
        }
    </script>
</body>
</html>